# AKFun å‰ç«¯è„šæ‰‹æ¶é¡¹ç›®ä¼˜åŒ–åˆ†ææŠ¥å‘Š

> ç”Ÿæˆæ—¥æœŸï¼š2025-11-16
> é¡¹ç›®ç‰ˆæœ¬ï¼šv5.1.13

## ğŸ“‹ é¡¹ç›®æ¦‚å†µ

AKFun æ˜¯ä¸€ä¸ªåŸºäº Webpack ä¸ Rollup çš„å¤šåœºæ™¯å‰ç«¯æ‰“åŒ…å·¥å…·ï¼Œæ”¯æŒ Vueã€Reactã€React+TS æŠ€æœ¯æ ˆã€‚ç»è¿‡å…¨é¢åˆ†æï¼Œå‘ç°ä»¥ä¸‹å¯ä¼˜åŒ–çš„å…³é”®é¢†åŸŸï¼š

---

## ğŸ”´ ä¸€ã€ä¾èµ–ç®¡ç†ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

### 1.1 ç‰ˆæœ¬è¿‡æ—§çš„ä¾èµ–åŒ…

**é—®é¢˜ï¼š**
- Node.js è¦æ±‚ç‰ˆæœ¬è¿‡ä½ï¼ˆ>= 10.13.0ï¼‰ï¼Œå»ºè®®è‡³å°‘ Node 14+
- éƒ¨åˆ†æ ¸å¿ƒä¾èµ–ç‰ˆæœ¬è¾ƒæ—§ï¼Œå­˜åœ¨å®‰å…¨é£é™©å’Œæ€§èƒ½é—®é¢˜

**å…·ä½“ä¾èµ–ï¼š**
```json
{
  "webpack": "^5.68.0",          // å½“å‰ç‰ˆæœ¬è¾ƒæ—§ï¼Œå»ºè®®å‡çº§åˆ° 5.90+
  "rollup": "^2.67.0",           // å»ºè®®å‡çº§åˆ° 3.x æˆ– 4.x
  "sass": "^1.49.7",             // å»ºè®®å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
  "less": "^4.1.3",              // å»ºè®®å‡çº§åˆ° 4.2+
  "typescript": "^4.5.5",        // å»ºè®®å‡çº§åˆ° 5.x
  "vue-loader": "^15.9.8"        // Vue 2.x çš„ loaderï¼Œè€ƒè™‘æ”¯æŒ Vue 3
}
```

**ä¼˜åŒ–å»ºè®®ï¼š**
```json
{
  "engines": {
    "node": ">= 16.0.0",
    "npm": ">= 8.0.0"
  }
}
```

### 1.2 å·²åºŸå¼ƒçš„ä¾èµ–åŒ…

**é—®é¢˜ï¼š**
```javascript
// package.json line 65
"@babel/polyfill": "^7.10.1"  // âŒ å·²è¢« @babel/preset-env çš„ useBuiltIns æ›¿ä»£
```

**ä¼˜åŒ–å»ºè®®ï¼š**
- ç§»é™¤ `@babel/polyfill`
- ä½¿ç”¨ `@babel/preset-env` çš„ `useBuiltIns: 'usage'` é…ç½®
- æ·»åŠ  `core-js: ^3.x` ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆ

### 1.3 peerDependencies ä¸å®Œæ•´

**é—®é¢˜ï¼š**
```json
"peerDependencies": {
  "chalk": "^4.0.0",
  "eslint": "^8.8.0",
  "ora": "^4.0.4"
}
```

**ä¼˜åŒ–å»ºè®®ï¼š**
```json
"peerDependencies": {
  "webpack": "^5.90.0",
  "vue": "^2.6.0 || ^3.0.0",
  "react": "^16.8.0 || ^17.0.0 || ^18.0.0",
  "react-dom": "^16.8.0 || ^17.0.0 || ^18.0.0"
},
"peerDependenciesMeta": {
  "vue": { "optional": true },
  "react": { "optional": true },
  "react-dom": { "optional": true }
}
```

---

## ğŸŸ¡ äºŒã€ä»£ç è´¨é‡ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

### 2.1 ç¼ºå°‘ TypeScript ç±»å‹å®šä¹‰

**é—®é¢˜ï¼š**
- æ•´ä¸ªé¡¹ç›®ä½¿ç”¨ JavaScript ç¼–å†™ï¼Œç¼ºå°‘ç±»å‹å®‰å…¨
- ç¼ºå°‘ `.d.ts` å£°æ˜æ–‡ä»¶ï¼Œå¯¹ TypeScript é¡¹ç›®ä¸å‹å¥½

**ä¼˜åŒ–å»ºè®®ï¼š**
1. å°†æ ¸å¿ƒæ¨¡å—é€æ­¥è¿ç§»åˆ° TypeScript
2. ä¸ºä¸»è¦ API æ·»åŠ ç±»å‹å£°æ˜æ–‡ä»¶
3. ç¤ºä¾‹ä»£ç ï¼š

```typescript
// types/index.d.ts
declare namespace AKFun {
  interface WebpackConfig {
    entry?: Record<string, string | string[]>;
    resolve?: {
      extensions?: string[];
      alias?: Record<string, string>;
    };
    createDeclaration?: boolean;
    ignoreNodeModules?: boolean;
    externals?: Record<string, string>;
    sassResources?: string[];
  }

  interface DevConfig {
    NODE_ENV: string;
    port: number;
    autoOpenBrowser: boolean;
    assetsPublicPath: string;
    assetsSubDirectory: string;
    hostname: string;
    proxyTable: Record<string, any>;
    cssSourceMap: boolean;
    https?: boolean;
  }

  interface AKFunConfig {
    settings: {
      enableESLint: boolean;
      enableESLintFix: boolean;
      enableStyleLint: boolean;
      enableStyleLintFix: boolean;
    };
    webpack: WebpackConfig;
    dev: DevConfig;
    build: BuildConfig;
    build2lib: BuildConfig;
    build2esm: BuildESMConfig;
  }

  export function dev(config?: Partial<AKFunConfig>): void;
  export function build(type: 'prod' | 'lib', config?: Partial<AKFunConfig>): void;
  export function build2esm(fileName?: string, config?: Partial<AKFunConfig>): void;
}

export = AKFun;
```

### 2.2 é”™è¯¯å¤„ç†ä¸å®Œå–„

**é—®é¢˜ç¤ºä¾‹ï¼š**

```javascript
// src/build.js line 44-45
rm(path.join(curEnvConfig.assetsRoot, curEnvConfig.assetsSubDirectory), (err) => {
  if (err) throw err;  // âŒ ç®€å•çš„ throwï¼Œç¼ºå°‘å‹å¥½çš„é”™è¯¯æç¤º
```

```javascript
// src/dev-server.js line 162
if (err) {
  _reject(err);  // âŒ _reject æœªå®šä¹‰ï¼Œä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯
}
```

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å·¥å…·
// src/utils/errorHandler.js
const chalk = require('chalk');

class AKFunError extends Error {
  constructor(message, code) {
    super(message);
    this.name = 'AKFunError';
    this.code = code;
  }
}

function handleError(error, context = '') {
  console.error(chalk.red(`\nâŒ ${context}é”™è¯¯ï¼š`));
  console.error(chalk.red(error.message));
  
  if (error.stack && process.env.DEBUG) {
    console.error(chalk.gray(error.stack));
  }
  
  console.error(chalk.yellow('\nğŸ’¡ å»ºè®®æ£€æŸ¥ï¼š'));
  console.error(chalk.yellow('  - é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®'));
  console.error(chalk.yellow('  - ä¾èµ–æ˜¯å¦å®Œæ•´å®‰è£…'));
  console.error(chalk.yellow('  - æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨\n'));
  
  process.exit(1);
}

module.exports = { AKFunError, handleError };
```

### 2.3 ä»£ç é‡å¤å’Œæ¨¡å—åŒ–ä¸è¶³

**é—®é¢˜ï¼š**
- å¤šä¸ªæ–‡ä»¶ä¸­é‡å¤çš„é…ç½®åˆå¹¶é€»è¾‘
- ç¼ºå°‘ç»Ÿä¸€çš„é…ç½®éªŒè¯æœºåˆ¶
- Webpack/Rollup é…ç½®ç”Ÿæˆé€»è¾‘å¯ä»¥è¿›ä¸€æ­¥æŠ½è±¡

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// src/utils/configValidator.js
const Joi = require('joi');

const akfunConfigSchema = Joi.object({
  settings: Joi.object({
    enableESLint: Joi.boolean().default(false),
    enableESLintFix: Joi.boolean().default(false),
    enableStyleLint: Joi.boolean().default(false),
    enableStyleLintFix: Joi.boolean().default(false)
  }),
  webpack: Joi.object({
    entry: Joi.alternatives().try(
      Joi.string(),
      Joi.array().items(Joi.string()),
      Joi.object().pattern(Joi.string(), Joi.alternatives().try(Joi.string(), Joi.array()))
    ),
    resolve: Joi.object({
      extensions: Joi.array().items(Joi.string()),
      alias: Joi.object().pattern(Joi.string(), Joi.string())
    })
  })
  // ... æ›´å¤šéªŒè¯è§„åˆ™
});

function validateConfig(config) {
  const { error, value } = akfunConfigSchema.validate(config, {
    allowUnknown: true,
    abortEarly: false
  });
  
  if (error) {
    throw new Error(`é…ç½®éªŒè¯å¤±è´¥ï¼š\n${error.details.map(d => `  - ${d.message}`).join('\n')}`);
  }
  
  return value;
}

module.exports = { validateConfig };
```

---

## ğŸŸ¡ ä¸‰ã€é…ç½®ç®¡ç†ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

### 3.1 é…ç½®æ–‡ä»¶åˆ†æ•£

**é—®é¢˜ï¼š**
- Babelã€ESLintã€StyleLintã€PostCSS ç­‰é…ç½®åˆ†æ•£åœ¨ä¸åŒä½ç½®
- ç¼ºå°‘ç»Ÿä¸€çš„é…ç½®ç®¡ç†å…¥å£
- ç”¨æˆ·è‡ªå®šä¹‰é…ç½®ä¸é»˜è®¤é…ç½®çš„åˆå¹¶é€»è¾‘ä¸å¤Ÿæ¸…æ™°

**ä¼˜åŒ–å»ºè®®ï¼š**
1. åˆ›å»ºé…ç½®ç®¡ç†å™¨ï¼š

```javascript
// src/config/ConfigManager.js
class ConfigManager {
  constructor() {
    this.defaultConfig = require('./default.config');
    this.userConfig = null;
    this.mergedConfig = null;
  }

  loadUserConfig(configPath) {
    try {
      this.userConfig = require(configPath);
      return this.userConfig;
    } catch (error) {
      console.warn(`æœªæ‰¾åˆ°ç”¨æˆ·é…ç½®æ–‡ä»¶: ${configPath}ï¼Œä½¿ç”¨é»˜è®¤é…ç½®`);
      return null;
    }
  }

  mergeConfig(userConfig) {
    const deepMerge = require('./deepMergeConfig');
    this.mergedConfig = deepMerge(this.defaultConfig, userConfig || this.userConfig);
    return this.mergedConfig;
  }

  getConfig(key) {
    if (!this.mergedConfig) {
      this.mergeConfig();
    }
    return key ? this.mergedConfig[key] : this.mergedConfig;
  }

  validateConfig() {
    const { validateConfig } = require('../utils/configValidator');
    return validateConfig(this.mergedConfig);
  }
}

module.exports = new ConfigManager();
```

### 3.2 ç¯å¢ƒå˜é‡ç®¡ç†

**é—®é¢˜ï¼š**
```javascript
// src/build.js line 40-42
if (!process.NODE_ENV) {
  process.NODE_ENV = curEnvConfig.NODE_ENV;  // âŒ ç›´æ¥ä¿®æ”¹ process å¯¹è±¡
}
```

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// src/utils/environment.js
const dotenv = require('dotenv');
const path = require('path');

class Environment {
  constructor() {
    this.loadEnvFiles();
  }

  loadEnvFiles() {
    const envFiles = [
      '.env',
      `.env.${process.env.NODE_ENV}`,
      `.env.${process.env.NODE_ENV}.local`,
      '.env.local'
    ];

    envFiles.forEach(file => {
      const envPath = path.resolve(process.cwd(), file);
      dotenv.config({ path: envPath });
    });
  }

  get(key, defaultValue) {
    return process.env[key] || defaultValue;
  }

  set(key, value) {
    process.env[key] = value;
  }

  is(env) {
    return process.env.NODE_ENV === env;
  }

  isDevelopment() {
    return this.is('development');
  }

  isProduction() {
    return this.is('production');
  }
}

module.exports = new Environment();
```

---

## ğŸŸ¢ å››ã€æ„å»ºæ€§èƒ½ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

### 4.1 ç¼“å­˜ä¼˜åŒ–

**é—®é¢˜ï¼š**
- ç¼ºå°‘ Webpack 5 çš„æŒä¹…åŒ–ç¼“å­˜é…ç½®
- Babelã€ESLint ç­‰å·¥å…·çš„ç¼“å­˜é…ç½®ä¸å®Œæ•´

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// webpack.base.conf.js æ·»åŠ 
module.exports = {
  cache: {
    type: 'filesystem',
    cacheDirectory: path.resolve(__dirname, '../node_modules/.cache/webpack'),
    buildDependencies: {
      config: [__filename]
    },
    name: `${config.NODE_ENV}-cache`
  },
  
  // ... å…¶ä»–é…ç½®
  
  module: {
    rules: [
      {
        test: /\.tsx?$/,
        use: [
          {
            loader: 'babel-loader',
            options: {
              ...babelConfig,
              cacheDirectory: true,
              cacheCompression: false
            }
          }
        ]
      }
    ]
  }
};
```

### 4.2 æ„å»ºåˆ†æå’Œç›‘æ§

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// src/utils/buildAnalyzer.js
const webpack = require('webpack');
const chalk = require('chalk');

class BuildAnalyzer {
  constructor() {
    this.startTime = null;
    this.endTime = null;
  }

  start() {
    this.startTime = Date.now();
    console.log(chalk.cyan('ğŸš€ å¼€å§‹æ„å»º...\n'));
  }

  end(stats) {
    this.endTime = Date.now();
    const buildTime = ((this.endTime - this.startTime) / 1000).toFixed(2);
    
    console.log(chalk.green(`\nâœ… æ„å»ºå®Œæˆï¼Œè€—æ—¶: ${buildTime}s`));
    
    if (stats) {
      const info = stats.toJson();
      
      console.log(chalk.cyan('\nğŸ“Š æ„å»ºç»Ÿè®¡ï¼š'));
      console.log(`  - èµ„æºæ•°é‡: ${info.assets.length}`);
      console.log(`  - æ¨¡å—æ•°é‡: ${info.modules.length}`);
      console.log(`  - å…¥å£æ•°é‡: ${Object.keys(info.entrypoints).length}`);
      
      if (info.warnings.length > 0) {
        console.log(chalk.yellow(`\nâš ï¸  è­¦å‘Š: ${info.warnings.length} ä¸ª`));
      }
      
      if (info.errors.length > 0) {
        console.log(chalk.red(`\nâŒ é”™è¯¯: ${info.errors.length} ä¸ª`));
      }
    }
  }
}

module.exports = BuildAnalyzer;
```

### 4.3 ç°ä»£åŒ–æ„å»ºç‰¹æ€§

**ä¼˜åŒ–å»ºè®®ï¼š**
1. æ”¯æŒ ES Module è¾“å‡º
2. æ”¯æŒ Tree Shaking
3. æ”¯æŒä»£ç åˆ†å‰²ä¼˜åŒ–
4. æ·»åŠ  Module Federation æ”¯æŒï¼ˆå¯é€‰ï¼‰

```javascript
// webpack.prod.conf.js æ·»åŠ 
module.exports = {
  optimization: {
    usedExports: true,
    sideEffects: true,
    moduleIds: 'deterministic',
    runtimeChunk: 'single',
    splitChunks: {
      chunks: 'all',
      cacheGroups: {
        vendor: {
          test: /[\\/]node_modules[\\/]/,
          name: 'vendors',
          priority: 10
        },
        common: {
          minChunks: 2,
          priority: 5,
          reuseExistingChunk: true
        }
      }
    }
  }
};
```

---

## ğŸ”µ äº”ã€æµ‹è¯•å’Œè´¨é‡ä¿éšœï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

### 5.1 ç¼ºå°‘å•å…ƒæµ‹è¯•

**é—®é¢˜ï¼š**
- é¡¹ç›®ä¸­æ²¡æœ‰ä»»ä½•æµ‹è¯•æ–‡ä»¶
- ç¼ºå°‘æµ‹è¯•æ¡†æ¶å’Œæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

**ä¼˜åŒ–å»ºè®®ï¼š**
1. æ·»åŠ  Jest æµ‹è¯•æ¡†æ¶
2. ä¸ºæ ¸å¿ƒå·¥å…·å‡½æ•°æ·»åŠ æµ‹è¯•

```json
// package.json æ·»åŠ 
{
  "devDependencies": {
    "jest": "^29.0.0",
    "@types/jest": "^29.0.0",
    "ts-jest": "^29.0.0"
  },
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage"
  }
}
```

```javascript
// tests/unit/utils/deepMergeConfig.test.js
const deepMergeConfig = require('../../../src/utils/deepMergeConfig');

describe('deepMergeConfig', () => {
  it('åº”è¯¥æ­£ç¡®åˆå¹¶ä¸¤ä¸ªç®€å•å¯¹è±¡', () => {
    const defaultConfig = { a: 1, b: 2 };
    const userConfig = { b: 3, c: 4 };
    const result = deepMergeConfig(defaultConfig, userConfig);
    
    expect(result).toEqual({ a: 1, b: 3, c: 4 });
  });

  it('åº”è¯¥ç”¨åè€…æ•°ç»„å®Œå…¨è¦†ç›–å‰è€…æ•°ç»„', () => {
    const defaultConfig = { arr: [1, 2, 3] };
    const userConfig = { arr: [4, 5] };
    const result = deepMergeConfig(defaultConfig, userConfig);
    
    expect(result.arr).toEqual([4, 5]);
  });

  it('åº”è¯¥æ·±åº¦åˆå¹¶åµŒå¥—å¯¹è±¡', () => {
    const defaultConfig = { 
      webpack: { 
        resolve: { extensions: ['.js'] } 
      } 
    };
    const userConfig = { 
      webpack: { 
        resolve: { alias: { '@': './src' } } 
      } 
    };
    const result = deepMergeConfig(defaultConfig, userConfig);
    
    expect(result.webpack.resolve).toEqual({
      extensions: ['.js'],
      alias: { '@': './src' }
    });
  });
});
```

### 5.2 ä»£ç è§„èŒƒ

**ä¼˜åŒ–å»ºè®®ï¼š**
```json
// .eslintrc.js æ·»åŠ æ›´ä¸¥æ ¼çš„è§„åˆ™
module.exports = {
  extends: [
    'eslint:recommended',
    'plugin:node/recommended',
    'prettier'
  ],
  rules: {
    'no-console': ['warn', { allow: ['warn', 'error'] }],
    'no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
    'prefer-const': 'error',
    'no-var': 'error'
  }
};
```

---

## ğŸ”µ å…­ã€æ–‡æ¡£å’Œå¼€å‘ä½“éªŒï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

### 6.1 æ–‡æ¡£æ”¹è¿›

**ä¼˜åŒ–å»ºè®®ï¼š**

```markdown
<!-- docs/API.md -->
# API æ–‡æ¡£

## å‘½ä»¤è¡Œæ¥å£

### akfun init
åˆ›å»ºæ–°é¡¹ç›®

**ç”¨æ³•ï¼š**
```bash
akfun init -t=<type> --dir=<directory> -n=<name>
```

**å‚æ•°ï¼š**
| å‚æ•° | åˆ«å | ç±»å‹ | å¿…å¡« | æè¿° |
|------|------|------|------|------|
| type | t | string | æ˜¯ | é¡¹ç›®ç±»å‹ï¼švue/react/react&ts/library |
| dir | d | string | å¦ | é¡¹ç›®ç›®å½•ï¼Œé»˜è®¤ä¸ºå½“å‰ç›®å½• |
| name | n | string | å¦ | é¡¹ç›®åç§°ï¼Œé»˜è®¤ä¸º myProject |

**ç¤ºä¾‹ï¼š**
```bash
# åˆ›å»º Vue é¡¹ç›®
akfun init -t=vue --dir=my-vue-app

# åˆ›å»º React+TypeScript é¡¹ç›®
akfun init -t=react&ts --dir=my-react-app
```

### akfun dev
å¯åŠ¨å¼€å‘æœåŠ¡å™¨

**ç”¨æ³•ï¼š**
```bash
akfun dev [options]
```

**é…ç½®é¡¹ï¼š**
åœ¨ `akfun.config.js` ä¸­é…ç½®ï¼š
```javascript
module.exports = {
  dev: {
    port: 8080,              // æœåŠ¡ç«¯å£
    autoOpenBrowser: true,   // è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
    https: false,            // å¯ç”¨ HTTPS
    proxyTable: {            // æ¥å£ä»£ç†
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true
      }
    }
  }
}
```

## ç¼–ç¨‹æ¥å£

### dev(config)
å¯åŠ¨å¼€å‘æœåŠ¡å™¨

**å‚æ•°ï¼š**
- `config` (Object, å¯é€‰): AKFun é…ç½®å¯¹è±¡

**è¿”å›å€¼ï¼š**
- Promise<void>

**ç¤ºä¾‹ï¼š**
```javascript
const { dev } = require('akfun');

dev({
  dev: {
    port: 8080,
    autoOpenBrowser: false
  }
});
```

### build(type, config)
æ„å»ºç”Ÿäº§ä»£ç 

**å‚æ•°ï¼š**
- `type` (String): æ„å»ºç±»å‹ï¼Œ'prod' æˆ– 'lib'
- `config` (Object, å¯é€‰): AKFun é…ç½®å¯¹è±¡

**è¿”å›å€¼ï¼š**
- Promise<void>

**ç¤ºä¾‹ï¼š**
```javascript
const { build } = require('akfun');

// æ„å»ºç”Ÿäº§ç¯å¢ƒä»£ç 
build('prod', {
  build: {
    assetsRoot: './dist',
    productionSourceMap: false
  }
});

// æ„å»ºåº“
build('lib', {
  build2lib: {
    libraryName: 'MyLib',
    assetsRoot: './lib'
  }
});
```
```

### 6.2 å‘½ä»¤è¡Œäº¤äº’ä¼˜åŒ–

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// module/index.js ä¼˜åŒ–äº¤äº’æç¤º
const inquirer = require('inquirer');
const chalk = require('chalk');

// æ·»åŠ æ›´å‹å¥½çš„é”™è¯¯æç¤º
const handleCommandError = (error, command) => {
  console.error(chalk.red(`\nâŒ æ‰§è¡Œ '${command}' å‘½ä»¤æ—¶å‡ºé”™ï¼š\n`));
  console.error(chalk.red(error.message));
  
  console.log(chalk.yellow('\nğŸ’¡ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š'));
  
  if (command === 'dev') {
    console.log(chalk.yellow('  1. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨'));
    console.log(chalk.yellow('  2. ç¡®è®¤ akfun.config.js é…ç½®æ­£ç¡®'));
    console.log(chalk.yellow('  3. å°è¯•åˆ é™¤ node_modules é‡æ–°å®‰è£…'));
  }
  
  console.log(chalk.cyan(`\nğŸ“š æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£: https://github.com/wibetter/akfun#readme\n`));
  process.exit(1);
};

// æ·»åŠ å‘½ä»¤æ‰§è¡Œå‰çš„ç¡®è®¤
yargs.command(
  'build',
  'æ„å»ºç”Ÿäº§ç¯å¢ƒä»£ç ',
  (yargs) => {
    yargs.option('confirm', {
      alias: 'y',
      type: 'boolean',
      description: 'è·³è¿‡ç¡®è®¤ç›´æ¥æ„å»º'
    });
  },
  async (argv) => {
    if (!argv.confirm) {
      const { confirmed } = await inquirer.prompt([
        {
          type: 'confirm',
          name: 'confirmed',
          message: 'ç¡®è®¤è¦æ„å»ºç”Ÿäº§ç¯å¢ƒä»£ç å—ï¼Ÿè¿™å°†æ¸…ç©º dist ç›®å½•ã€‚',
          default: true
        }
      ]);
      
      if (!confirmed) {
        console.log(chalk.yellow('å·²å–æ¶ˆæ„å»º'));
        return;
      }
    }
    
    try {
      mainAction.build('prod');
    } catch (error) {
      handleCommandError(error, 'build');
    }
  }
);
```

### 6.3 è°ƒè¯•æ”¯æŒ

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// src/utils/logger.js
const chalk = require('chalk');
const debug = require('debug');

const akfunDebug = debug('akfun');

class Logger {
  constructor(namespace = 'akfun') {
    this.debug = debug(namespace);
    this.verbose = process.env.AKFUN_VERBOSE === 'true';
  }

  info(message) {
    console.log(chalk.cyan(`â„¹ ${message}`));
  }

  success(message) {
    console.log(chalk.green(`âœ“ ${message}`));
  }

  warn(message) {
    console.warn(chalk.yellow(`âš  ${message}`));
  }

  error(message) {
    console.error(chalk.red(`âœ– ${message}`));
  }

  debug(message) {
    if (this.verbose) {
      this.debug(message);
    }
  }

  table(data) {
    console.table(data);
  }
}

module.exports = new Logger();
```

---

## ğŸŸ£ ä¸ƒã€æ¶æ„å’Œæ‰©å±•æ€§ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

### 7.1 æ’ä»¶ç³»ç»Ÿ

**é—®é¢˜ï¼š**
- å½“å‰ç¼ºå°‘æ’ä»¶æœºåˆ¶ï¼Œä¸æ˜“æ‰©å±•
- ç¬¬ä¸‰æ–¹å¼€å‘è€…æ— æ³•æ–¹ä¾¿åœ°æ·»åŠ åŠŸèƒ½

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// src/core/PluginManager.js
class PluginManager {
  constructor() {
    this.plugins = [];
    this.hooks = {
      beforeDev: [],
      afterDev: [],
      beforeBuild: [],
      afterBuild: [],
      configResolved: []
    };
  }

  use(plugin) {
    if (typeof plugin === 'function') {
      plugin(this);
    } else if (plugin && typeof plugin.apply === 'function') {
      plugin.apply(this);
    }
    this.plugins.push(plugin);
    return this;
  }

  hook(name, fn) {
    if (this.hooks[name]) {
      this.hooks[name].push(fn);
    }
    return this;
  }

  async runHooks(name, ...args) {
    const hooks = this.hooks[name] || [];
    for (const hook of hooks) {
      await hook(...args);
    }
  }
}

module.exports = PluginManager;
```

```javascript
// æ’ä»¶ä½¿ç”¨ç¤ºä¾‹
// plugins/ossUploadPlugin.js
class OSSUploadPlugin {
  constructor(options) {
    this.options = options;
  }

  apply(pluginManager) {
    pluginManager.hook('afterBuild', async (config, stats) => {
      console.log('å¼€å§‹ä¸Šä¼ åˆ° OSS...');
      // ä¸Šä¼ é€»è¾‘
    });
  }
}

module.exports = OSSUploadPlugin;
```

### 7.2 å¤šæ¡†æ¶æ”¯æŒæ¶æ„

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// src/frameworks/index.js
class FrameworkAdapter {
  constructor(framework) {
    this.framework = framework;
  }

  getWebpackConfig(baseConfig) {
    throw new Error('å­ç±»å¿…é¡»å®ç° getWebpackConfig æ–¹æ³•');
  }

  getRollupConfig(baseConfig) {
    throw new Error('å­ç±»å¿…é¡»å®ç° getRollupConfig æ–¹æ³•');
  }
}

class VueAdapter extends FrameworkAdapter {
  getWebpackConfig(baseConfig) {
    const VueLoaderPlugin = require('vue-loader/lib/plugin');
    return {
      ...baseConfig,
      module: {
        rules: [
          ...baseConfig.module.rules,
          {
            test: /\.vue$/,
            loader: 'vue-loader'
          }
        ]
      },
      plugins: [
        ...baseConfig.plugins,
        new VueLoaderPlugin()
      ]
    };
  }
}

class ReactAdapter extends FrameworkAdapter {
  getWebpackConfig(baseConfig) {
    return {
      ...baseConfig,
      // React ç‰¹å®šé…ç½®
    };
  }
}

class FrameworkFactory {
  static create(framework) {
    switch (framework) {
      case 'vue':
      case 'vue2':
        return new VueAdapter('vue2');
      case 'vue3':
        return new VueAdapter('vue3');
      case 'react':
        return new ReactAdapter('react');
      default:
        throw new Error(`ä¸æ”¯æŒçš„æ¡†æ¶: ${framework}`);
    }
  }
}

module.exports = { FrameworkFactory, FrameworkAdapter };
```

---

## ğŸŸ£ å…«ã€å®‰å…¨æ€§ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

### 8.1 ä¾èµ–å®‰å…¨å®¡è®¡

**ä¼˜åŒ–å»ºè®®ï¼š**
1. æ·»åŠ  npm audit è‡ªåŠ¨æ£€æŸ¥
2. ä½¿ç”¨ Snyk æˆ– Dependabot

```json
// package.json æ·»åŠ 
{
  "scripts": {
    "security:audit": "npm audit",
    "security:fix": "npm audit fix"
  }
}
```

### 8.2 é…ç½®éªŒè¯å’Œé˜²æŠ¤

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// src/utils/security.js
const path = require('path');

class SecurityValidator {
  // éªŒè¯è·¯å¾„æ˜¯å¦å®‰å…¨
  static validatePath(filePath) {
    const normalizedPath = path.normalize(filePath);
    
    // é˜²æ­¢è·¯å¾„éå†æ”»å‡»
    if (normalizedPath.includes('..')) {
      throw new Error('ä¸å…è®¸ä½¿ç”¨ç›¸å¯¹è·¯å¾„ ".."');
    }
    
    // æ£€æŸ¥æ˜¯å¦è®¿é—®æ•æ„Ÿç›®å½•
    const sensitiveDirs = ['/etc', '/root', '/usr/bin'];
    if (sensitiveDirs.some(dir => normalizedPath.startsWith(dir))) {
      throw new Error('ä¸å…è®¸è®¿é—®ç³»ç»Ÿæ•æ„Ÿç›®å½•');
    }
    
    return normalizedPath;
  }

  // éªŒè¯ URL
  static validateURL(url) {
    try {
      const parsed = new URL(url);
      
      // åªå…è®¸ http/https åè®®
      if (!['http:', 'https:'].includes(parsed.protocol)) {
        throw new Error('åªå…è®¸ http/https åè®®');
      }
      
      return url;
    } catch (error) {
      throw new Error(`æ— æ•ˆçš„ URL: ${url}`);
    }
  }

  // éªŒè¯ç«¯å£å·
  static validatePort(port) {
    const portNum = parseInt(port, 10);
    
    if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
      throw new Error('ç«¯å£å·å¿…é¡»åœ¨ 1-65535 ä¹‹é—´');
    }
    
    // é¿å…ä½¿ç”¨ç³»ç»Ÿä¿ç•™ç«¯å£
    if (portNum < 1024 && process.platform !== 'win32') {
      throw new Error('åœ¨é Windows ç³»ç»Ÿä¸Šä¸å»ºè®®ä½¿ç”¨ 1024 ä»¥ä¸‹çš„ç«¯å£');
    }
    
    return portNum;
  }
}

module.exports = SecurityValidator;
```

---

## ğŸ“Š ä¹ã€æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

### 9.1 æ„å»ºæ€§èƒ½è¿½è¸ª

**ä¼˜åŒ–å»ºè®®ï¼š**
```javascript
// src/utils/performance.js
const { performance } = require('perf_hooks');

class PerformanceMonitor {
  constructor() {
    this.marks = new Map();
    this.measures = [];
  }

  mark(name) {
    this.marks.set(name, performance.now());
  }

  measure(name, startMark, endMark) {
    const start = this.marks.get(startMark);
    const end = endMark ? this.marks.get(endMark) : performance.now();
    
    if (start === undefined) {
      throw new Error(`æœªæ‰¾åˆ°èµ·å§‹æ ‡è®°: ${startMark}`);
    }
    
    const duration = end - start;
    this.measures.push({ name, duration, startMark, endMark });
    
    return duration;
  }

  report() {
    console.log('\nğŸ“Š æ€§èƒ½æŠ¥å‘Šï¼š');
    console.table(
      this.measures.map(m => ({
        'ä»»åŠ¡': m.name,
        'è€—æ—¶(s)': (m.duration / 1000).toFixed(2)
      }))
    );
  }

  clear() {
    this.marks.clear();
    this.measures = [];
  }
}

module.exports = new PerformanceMonitor();
```

---

## ğŸ¯ åã€ä¼˜å…ˆçº§å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1-2å‘¨ï¼‰- ç«‹å³ä¿®å¤
1. âœ… ç§»é™¤ `@babel/polyfill`ï¼Œä½¿ç”¨ `core-js`
2. âœ… ä¿®å¤ `dev-server.js` ä¸­çš„ `_reject` æœªå®šä¹‰é”™è¯¯
3. âœ… å‡çº§å…³é”®ä¾èµ–ï¼ˆwebpackã€rollupã€typescriptï¼‰
4. âœ… æ·»åŠ å®Œæ•´çš„ peerDependencies
5. âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶

### ç¬¬äºŒé˜¶æ®µï¼ˆ2-4å‘¨ï¼‰- è´¨é‡æå‡
1. ğŸ”„ æ·»åŠ  TypeScript ç±»å‹å®šä¹‰æ–‡ä»¶
2. ğŸ”„ å®ç°é…ç½®éªŒè¯æœºåˆ¶
3. ğŸ”„ æ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ > 60%ï¼‰
4. ğŸ”„ ä¼˜åŒ–æ„å»ºæ€§èƒ½ï¼ˆæ·»åŠ ç¼“å­˜ï¼‰
5. ğŸ”„ å®Œå–„æ–‡æ¡£å’Œç¤ºä¾‹

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ1-2æœˆï¼‰- æ¶æ„ä¼˜åŒ–
1. ğŸ“… è®¾è®¡å’Œå®ç°æ’ä»¶ç³»ç»Ÿ
2. ğŸ“… é‡æ„ä¸º TypeScript
3. ğŸ“… æ”¯æŒ Vue 3 å’Œ React 18
4. ğŸ“… æ·»åŠ æ€§èƒ½ç›‘æ§
5. ğŸ“… å®Œå–„ CI/CD æµç¨‹

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒé—®é¢˜æ€»ç»“ï¼š
1. **ä¾èµ–è¿‡æ—§** - å­˜åœ¨å®‰å…¨é£é™©ï¼Œéœ€è¦å‡çº§
2. **ç¼ºå°‘ç±»å‹ç³»ç»Ÿ** - ç»´æŠ¤å›°éš¾ï¼Œå»ºè®®è¿ç§» TypeScript
3. **é”™è¯¯å¤„ç†ä¸è¶³** - ç”¨æˆ·ä½“éªŒå·®ï¼Œéœ€è¦ç»Ÿä¸€å¤„ç†
4. **ç¼ºå°‘æµ‹è¯•** - ä»£ç è´¨é‡æ— ä¿éšœ
5. **æ‰©å±•æ€§ä¸è¶³** - ç¼ºå°‘æ’ä»¶æœºåˆ¶

### é¢„æœŸæ”¶ç›Šï¼š
- **å¯ç»´æŠ¤æ€§æå‡ 40%** - é€šè¿‡ç±»å‹ç³»ç»Ÿå’Œæµ‹è¯•
- **æ„å»ºæ€§èƒ½æå‡ 30%** - é€šè¿‡ç¼“å­˜ä¼˜åŒ–
- **å¼€å‘ä½“éªŒæå‡ 50%** - é€šè¿‡æ›´å¥½çš„é”™è¯¯æç¤ºå’Œæ–‡æ¡£
- **æ‰©å±•æ€§æå‡ 60%** - é€šè¿‡æ’ä»¶ç³»ç»Ÿ

### å»ºè®®çš„æŠ€æœ¯æ ˆå‡çº§ï¼š
```json
{
  "æ¨èæŠ€æœ¯æ ˆ": {
    "è¯­è¨€": "TypeScript",
    "æµ‹è¯•": "Jest + Testing Library",
    "ä»£ç è´¨é‡": "ESLint + Prettier + Husky",
    "æ–‡æ¡£": "VitePress æˆ– Docusaurus",
    "CI/CD": "GitHub Actions",
    "åŒ…ç®¡ç†": "pnpm"
  }
}
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Webpack 5 è¿ç§»æŒ‡å—](https://webpack.js.org/migrate/5/)
- [Rollup 4 æ–‡æ¡£](https://rollupjs.org/)
- [TypeScript æœ€ä½³å®è·µ](https://www.typescriptlang.org/docs/handbook/declaration-files/introduction.html)
- [Jest æµ‹è¯•æŒ‡å—](https://jestjs.io/docs/getting-started)
- [npm åŒ…å¼€å‘æœ€ä½³å®è·µ](https://docs.npmjs.com/packages-and-modules/contributing-packages-to-the-registry)

---

**æŠ¥å‘Šç”Ÿæˆè€…ï¼š** AI Code Analyzer  
**è”ç³»æ–¹å¼ï¼š** GitHub Issues  
**æœ€åæ›´æ–°ï¼š** 2025-11-16

