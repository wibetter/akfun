# AKFun 配置管理使用指南

> 版本：v5.2.0+  
> 更新日期：2025-11-16

## 📖 概述

AKFun v5.2.0 引入了全新的配置管理系统，提供更强大、更灵活的配置管理能力：

- ✅ **统一配置管理** - ConfigManager 统一管理所有配置
- ✅ **配置验证** - 自动验证配置的正确性
- ✅ **向后兼容** - 完全兼容旧版配置方式

---

## 🚀 快速开始

### 基础使用（无需改动）

对于大多数用户，新的配置管理系统是**透明的**，您无需修改任何代码：

```javascript
// akfun.config.js - 和以前一样
module.exports = {
  dev: {
    port: 8080,
    autoOpenBrowser: true
  },
  build: {
    assetsRoot: './dist'
  }
};
```

```bash
# 命令行使用 - 和以前一样
akfun dev
akfun build
```

### 高级使用（使用新特性）

如果您想使用新的配置管理功能：

```javascript
// 在您的脚本中
const { configManager, validateConfig } = require('akfun');

// 加载配置
configManager.loadUserConfig('./my-config.js');
const config = configManager.mergeConfig();

// 验证配置
validateConfig(config);
```

---

## 📋 ConfigManager API

### 基本方法

#### `loadUserConfig(configPath)`

加载用户配置文件。

**参数：**
- `configPath` (String) - 配置文件路径（相对或绝对路径）

**返回值：**
- `Object | null` - 用户配置对象，如果加载失败返回 `null`

**示例：**
```javascript
const configManager = require('akfun').configManager;

// 加载指定配置文件
configManager.loadUserConfig('./akfun.config.js');

// 加载绝对路径的配置文件
configManager.loadUserConfig('/path/to/config.js');
```

#### `autoLoadConfig()`

自动查找并加载配置文件，按以下优先级查找：
1. `akfun.config.js`
2. `akfun.config.json`
3. `.akfunrc.js`
4. `.akfunrc.json`

**返回值：**
- `Object | null` - 找到的配置对象，未找到返回 `null`

**示例：**
```javascript
// 自动查找配置文件
configManager.autoLoadConfig();
```

#### `mergeConfig(userConfig)`

合并用户配置和默认配置。

**参数：**
- `userConfig` (Object, 可选) - 用户配置对象

**返回值：**
- `Object` - 合并后的配置对象

**示例：**
```javascript
// 使用已加载的配置合并
const config = configManager.mergeConfig();

// 使用自定义配置合并
const customConfig = { dev: { port: 9000 } };
const config = configManager.mergeConfig(customConfig);
```

#### `getConfig(key)`

获取配置值，支持点号分隔的键路径。

**参数：**
- `key` (String, 可选) - 配置键路径，如 `'webpack.resolve.alias'`

**返回值：**
- `any` - 配置值，如果不存在返回 `undefined`

**示例：**
```javascript
// 获取整个配置
const allConfig = configManager.getConfig();

// 获取顶层配置
const devConfig = configManager.getConfig('dev');

// 获取嵌套配置
const aliases = configManager.getConfig('webpack.resolve.alias');
const port = configManager.getConfig('dev.port');
```

#### `setConfig(key, value)`

设置配置值（仅在内存中生效）。

**参数：**
- `key` (String) - 配置键路径
- `value` (any) - 配置值

**示例：**
```javascript
// 设置简单值
configManager.setConfig('dev.port', 9000);

// 设置对象值
configManager.setConfig('webpack.resolve.alias', {
  '@': './src',
  '@components': './src/components'
});

// 设置嵌套值
configManager.setConfig('dev.proxyTable./api', {
  target: 'http://api.example.com',
  changeOrigin: true
});
```

### 验证方法

#### `validateConfig()`

验证当前配置的正确性。

**返回值：**
- `Object` - 验证后的配置对象

**抛出异常：**
- 如果配置验证失败，会抛出详细的错误信息

**示例：**
```javascript
try {
  const validConfig = configManager.validateConfig();
  console.log('配置验证通过');
} catch (error) {
  console.error('配置验证失败:', error.message);
}
```

### 工具方法

#### `exportConfig(outputPath)`

导出当前配置到 JSON 文件（用于调试）。

**参数：**
- `outputPath` (String) - 输出文件路径

**示例：**
```javascript
// 导出配置用于调试
configManager.exportConfig('./debug-config.json');
```

#### `reset()`

重置配置管理器状态。

**示例：**
```javascript
// 重置配置
configManager.reset();
```

#### `getDefaultConfig()`

获取默认配置对象。

**返回值：**
- `Object` - 默认配置

#### `getUserConfig()`

获取用户配置对象。

**返回值：**
- `Object | null` - 用户配置

---

## ✅ 配置验证

### 使用 validateConfig

```javascript
const { validateConfig } = require('akfun');

const config = {
  dev: {
    port: 8080,
    autoOpenBrowser: true
  },
  webpack: {
    resolve: {
      extensions: ['.js', '.jsx', '.ts', '.tsx']
    }
  }
};

try {
  const validConfig = validateConfig(config);
  console.log('配置验证通过');
} catch (error) {
  console.error('配置验证失败:', error.message);
}
```

### 验证规则

配置验证器会检查以下内容：

1. **必需字段** - `dev`, `build`, `webpack` 等必须存在
2. **类型检查** - 确保字段类型正确（如 port 必须是数字）
3. **值范围** - 确保值在合理范围内（如端口号 1-65535）
4. **路径验证** - 检查路径字段的有效性
5. **依赖关系** - 检查配置项之间的依赖关系

### 验证错误示例

```javascript
// ❌ 错误的配置
const badConfig = {
  dev: {
    port: 'abc',  // 应该是数字
    autoOpenBrowser: 'yes'  // 应该是布尔值
  }
};

validateConfig(badConfig);
// 抛出错误：
// - dev.port 必须是数字
// - dev.autoOpenBrowser 必须是布尔值
```

---

## 💡 实践示例

### 示例 1：配置验证和调试

```javascript
const { configManager, validateConfig } = require('akfun');

// 加载配置
configManager.autoLoadConfig();
const config = configManager.mergeConfig();

// 开启调试模式
process.env.AKFUN_DEBUG = 'true';

// 验证配置
try {
  validateConfig(config);
  console.log('✓ 配置验证通过');
  
  // 导出配置用于调试
  if (process.env.DEBUG_CONFIG) {
    configManager.exportConfig('./debug/config.json');
  }
} catch (error) {
  console.error('✗ 配置验证失败');
  console.error(error.message);
  process.exit(1);
}
```

### 示例 2：编程式构建

```javascript
const { build, configManager } = require('akfun');

// 自定义配置
const customConfig = {
  build: {
    assetsRoot: './custom-dist',
    productionSourceMap: false,
    bundleAnalyzerReport: true
  },
  webpack: {
    resolve: {
      alias: {
        '@': './src',
        '@components': './src/components'
      }
    }
  }
};

// 合并配置
configManager.mergeConfig(customConfig);

// 验证配置
configManager.validateConfig();

// 执行构建
build('prod', configManager.getConfig());
```

### 示例 3：多项目配置管理

```javascript
// scripts/build-all.js
const { build, configManager } = require('akfun');
const path = require('path');

const projects = [
  { name: 'admin', config: './config/admin.config.js' },
  { name: 'mobile', config: './config/mobile.config.js' },
  { name: 'desktop', config: './config/desktop.config.js' }
];

async function buildAll() {
  for (const project of projects) {
    console.log(`\n构建项目: ${project.name}`);
    
    // 重置配置管理器
    configManager.reset();
    
    // 加载项目配置
    configManager.loadUserConfig(project.config);
    const config = configManager.mergeConfig();
    
    // 验证配置
    configManager.validateConfig();
    
    // 执行构建
    await build('prod', config);
    
    console.log(`✓ ${project.name} 构建完成\n`);
  }
}

buildAll().catch(error => {
  console.error('构建失败:', error);
  process.exit(1);
});
```

---

## 🔧 调试和故障排查

### 开启调试模式

```bash
# 通过环境变量开启调试
AKFUN_DEBUG=true akfun dev

# 或在脚本中设置
process.env.AKFUN_DEBUG = 'true';
```

调试模式会输出：
- 配置加载过程
- 配置合并详情
- 环境变量信息
- 错误堆栈信息

### 导出当前配置

```javascript
const { configManager } = require('akfun');

// 导出完整配置
configManager.exportConfig('./debug/current-config.json');

// 查看特定配置
console.log('Dev配置:', configManager.getConfig('dev'));
console.log('Webpack配置:', configManager.getConfig('webpack'));
```

### 常见问题

#### 1. 配置文件未找到

**问题：** `⚠️  未找到用户配置文件`

**解决方案：**
- 确保配置文件在项目根目录
- 检查文件名是否正确（`akfun.config.js`）
- 使用绝对路径加载配置

#### 2. 配置验证失败

**问题：** `❌ 配置验证失败`

**解决方案：**
- 查看详细的错误信息
- 确保配置项类型正确
- 参考默认配置的格式

## 📚 更多资源

- [默认配置参考](../src/config/default.config.js)
- [配置验证规则](../src/utils/configValidator.js)
